# SLAMon Agent Fleet Manager (AFM) HTTP API Version 1
 AFM provides a HTTP interface to that agents can use to access it. 
 AFM is accessed over HTTP using SSL protected connection. 
 HTTP requests contain JSON-data describing the desired action.
##  Claiming tasks
### Request
Agents can request for tasks by making a POST request to:

`https://AFM.url.to.be.set/tasks`

Task request body is JSON encoded string and has to contain following 
information:

* Protocol version - version of the protocol client is using for communication
* Agent ID - unique identifier (UUID) that differentiates agent from others. 
ID is generated by agent and should be preserved as long as the agent is 
installed.
* Agent name - A human readable name of the agent application
* Agent time - local time of the agent with time zone info in ISO 8601 format
* Agent capabilities - JSON object containing  tasks that agent can execute
    * Each entry will be named by tasks type name and should contain information
   about supported version of the task
* Maximum number of tasks accepted at once - zero or positive integer. Zero 
indicates that agent is busy executing previous task but is reporting to 
be alive.

Task request might also contain these attributes when appropriate:

* Agent geolocation - JSON dictionary containing 
    * Country in format described in ISO 3166-1 alpha-2
    * Region / principal subdivision of the country
    * Latitude - WGS84 latitude as floating point decimal number
    * Longitude - WGS84 longitude as floating point decimal number
  
 At the moment AFM doesn’t care about version, time or geolocation but
  they will be used later during the project. Also task versions are ignored 
  for now but having to specify them will provide flexibility for updating 
  in the future.
 
 Example request:

```json
{
	 "protocol": 1,
	 "agent_id": "123e4567-e89b-12d3-a456-426655440000",
	 "agent_name": "Python Agent v1",
	 "agent_location": {
	 	"country": "FI",
	 	"region": "18",
	 },
	 "agent_time": "2012-04-23T18:25:43.511Z",
	 "agent_capabilities": {
	 	"task-type-1": {"version": 1},
	 	"task-type-2": {"version": 1}
	 },
	 "max_tasks": 1
}
```


### Response
For successful request AFM will respond with HTTP status 200 OK.

If some of the information from request is missing or invalid or the request 
is not valid JSON-request, AFM will respond with 400 Bad Request. 
This most likely is due to outdated agent. In this case the agent should 
log the error and discontinue polling for tasks. Same applies also for 
incomplete and erroneous JSON responses.

If the agent hasn’t registered to AFM HTTP status 401 Unauthorized 
will be returned. This shouldn’t be happening with protocol version 1 
since no authentication mechanism is specified.

All server errors (HTTP 5xx) and connectivity errors are handled as temporary 
errors, and the agent should continue polling with default polling interval.

The body of the response will contain following information in JSON-format:
* Tasks - an array containing 0 to n tasks that the agent should do in 
following format
  * Task id - Unique identifier (probably UUID) for task instance
  * Task type and version - the name and version of the task, which must 
  match to one of the tasks client reported as supported in request
  * Task input data - task dependant data as JSON object
* Return time - next time that agent should ask for more tasks, including 
time zone info in ISO 8601 format

Example response:
	
```json
{
	 "tasks": [{
 	 	"task_id": "123e4567-e89b-12d3-a456-426655440000",
	 	"task_type": "task-type-1",
	 	"task_version": 1,
	 	"task_data": {
	 		"key": "value"
	 	}
	 }],
	 "return_time": "2012-04-23T18:25:43.511Z"
}
```
	
### Posting task results
After the agent has executed the task, it will upload results back to 
the AFM.
Results are posted by making POST request to URL similar to following:

`https://AFM.url.to.be.set/tasks`

Request body is JSON encoded string and has to contain following information:
* Protocol version number
* Unique identifier of the claimed task instance
* Task output data as JSON dictionary

Example request:

```json
{
	 "protocol": 1,
	 "task_id": "123e4567-e89b-12d3-a456-426655440000",
	 "task_data": {
	 	"key": "value"
	 }
}
```

In case an error is encountered during task execution, error should be posted 
instead of task result.

Example error:

```json
{
	 "protocol": 1,
	 "task_id": "123e4567-e89b-12d3-a456-426655440000",
	 "task_error": "error described as a string"
}
```

### Response
For successful post AFM will respond with HTTP status 200 OK.

* If some of the information from request is missing or invalid, AFM 
will respond with 400 Bad Request. In this case agent should stop result 
upload attempts immediately.
* If result submission fails on server side, server should respond with 5xx 
server error codes. In this case agent should keep retrying uploads. Same 
applies also for connectivity errors during the HTTP request.